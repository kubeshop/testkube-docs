import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

# Concurrency & Queueing

By default, Testkube allows multiple executions within the same workflow to run concurrently.
This means that multiple instances of the same execution can run at the same time, performing the same steps.
You can control this when such steps should not run simultaneously or when you want to control the amount of
executions running.

## Workflow Concurrency Policy

### Limit concurrency of this workflow

You can limit the concurrency within a workflow by setting `spec.concurrency.max`.
Prevent concurrent runs by setting this to `1` or set it to any positive number to
allow multiple concurrent runs up to this maximum. Setting this to `0` will run unlimited concurrent workflows.

When the maximum amount of concurrent execution is reached, all new executions will remain queued until previously ongoing executions are finished.

```yaml
kind: TestWorkflow
spec:
  concurrency:
    max: 1
```

### Limit concurrency across workflows

By default, the concurrency is based on the workflow's name. You can set a `spec.concurrency.group` to instead
base concurrency on this key. The benefit is that you can use this across multiple workflows. As always, you
can use templates as a reusable building block across workflows:

```yaml
kind: TestWorkflowTemplate
metadata:
  name: concurrency-shared-database
spec:
  concurrency:
    max: 2
    group: shared-database
---
kind: TestWorkflow
metadata:
  name: workflow-foo
spec:
  use:
    - name: concurrency-shared-database
---
kind: TestWorkflow
metadata:
  name: workflow-bar
spec:
  use:
    - name: concurrency-shared-database
```

:::note
We strongly recommend to always use Test Workflow Templates for concurrency groups
to ensure consistency across workflows.
:::

## Runner Concurrency Limit

Queue this execution when ongoing executions when all runners surpasses given threshold.

By default a runner has a concurrency limit of 250. You can further restrict this within the dashboard's Environment Settings > Queueing & Concurrency.

## Environment Queue Limit

Executions might be queued because there are no matching runner candidates or because concurrency policies and limits.
The total queue size has a maximum capacity after which newly scheduled executions will immediately abort.

By default an environment has a queue limit of 1000. You can further restrict this within the dashboard's Environment Settings > Queueing & Concurrency.

## Execution Timeouts

Testkube times out executions to improve reliability and fault tolerance of the system:

- Executions stuck in the queue for one day will be aborted.
- Executions stuck ongoing for seven days will be gracefully aborted; and force aborted twelve hours after that.
