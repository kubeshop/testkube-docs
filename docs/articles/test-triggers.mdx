# Kubernetes Event Triggers

Testkube allows you to automate running test workflows by defining triggers on certain events for various Kubernetes resources.

## What is a Testkube Event Trigger?

In generic terms, a _trigger_ defines an _action_ which will be executed for a given _execution_ when a certain _event_ on a specific _resource_ occurs.

In Testkube, event triggers allow you to trigger the execution of a workflow based on Kubernetes events - for example when a `Deployment` is updated
or an `Ingress` gets deleted.

You can currently manage event triggers in the Testkube Dashboard or by interacting with corresponding `TestTrigger` custom resources
via `kubectl`.

## Creating Test Triggers in the Testkube Dashboard

Click on the lightening bolt icon on the left of the Testkube Dashboard and then click on the `Create my first trigger` button.

![Trigger Screen](../img/create-trigger.png)

The `Create a new trigger` dialog opens, where one can configure the condition for the trigger:

![Create Trigger Condition](../img/create-trigger-form.png)

After clicking `Next`, then one can configure the action to execute on the trigger and then click `Create` to create it.

![Create Trigger Action](../img/create-trigger-form-action.png)

## Custom Resource Definition Model

### Selectors

Triggers use Selectors to specify which events to listen for.

The `resourceSelector` and `testSelector` fields support selecting resources either by name or using
the Kubernetes [Label Selector](https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#resources-that-support-set-based-requirements).

Each selector should specify the `namespace` of the object, otherwise the namespace defaults to `testkube`.

```
selector := resourceSelector | testSelector
```

#### Name Selector

Name selectors are used when we want to select a specific resource in a specific namespace.

```yaml
selector:
  name: Kubernetes object name
  nameRegex: Kubernetes object name regex (for example, "testworkflow.*")
  namespace: Kubernetes object namespace (default is **testkube**)
```

#### Label Selector

Label selectors are used when we want to select a group of resources in a specific namespace.

```yaml
selector:
  namespace: Kubernetes object namespace (default is **testkube**)
  labelSelector:
    matchLabels: map of key-value pairs
    matchExpressions:
      - key: label name
        operator: [In | NotIn | Exists | DoesNotExist
        values: list of values
```

### Resource Conditions

Resource Conditions allows triggers to be defined based on the status conditions for a specific resource.

```yaml
conditionSpec:
  timeout: Duration in seconds the test trigger waits for conditions, until its stopped.
  delay: Duration in seconds the test trigger waits between condition checks.
  conditions:
    - type: test trigger condition type
      status: test trigger condition status, supported values - True, False, Unknown
      reason: test trigger condition reason
      ttl: test trigger condition ttl
```

### Resource Probes

Resource Probes allows triggers to be defined based on the probe status.

```yaml
probeSpec:
  timeout: Duration in seconds the test trigger waits for probes, until its stopped.
  delay: Duration in seconds the test trigger waits between probes.
  probes:
    - scheme: test trigger condition probe scheme to connect to host, default is http
      host: test trigger condition probe host, default is pod ip or service name
      path: test trigger condition probe path to check, default is /
      port: test trigger condition probe port to connect
      headers: test trigger condition probe headers to submit
```

### Supported Values

- **Resource** - pod, deployment, statefulset, daemonset, service, ingress, event, configmap
- **Action** - run
- **Event** - created, modified, deleted
- **Cause** (can be used instead of **Event**)
  - For deployments - deployment-scale-update, deployment-image-update, deployment-env-update, deployment-containers-modified
  - For Testkube events - event-queue-testworkflow, event-start-testworkflow, event-end-testworkflow-success, event-end-testworkflow-failed, event-end-testworkflow-aborted, event-created, event-updated, event-deleted
- **Execution** - testworkflow
- **ConcurrencyPolicy** - allow, forbid, replace

## Example

Here is an example for a **Test Trigger** _default/testtrigger-example_ which runs the **TestSuite** _frontend/sanity-test_
when a **deployment** containing the label **testkube.io/tier: backend** gets **modified** and also has the conditions **Progressing: True: NewReplicaSetAvailable** and **Available: True**.

```yaml
apiVersion: tests.testkube.io/v1
kind: TestTrigger
metadata:
  name: testtrigger-example
  namespace: default
spec:
  resource: deployment
  resourceSelector:
    labelSelector:
      matchLabels:
        testkube.io/tier: backend
  event: modified
  conditionSpec:
    timeout: 100
    delay: 2
    conditions:
      - type: Progressing
        status: "True"
        reason: "NewReplicaSetAvailable"
        ttl: 60
      - type: Available
        status: "True"
  probeSpec:
    timeout: 50
    delay: 1
    probes:
      - scheme: http
        host: testkube-api-server
        path: /health
        port: 8088
        headers:
          X-Token: "12345"
      - host: testkube-dashboard
        port: 8080
  action: run
  execution: testworkflow
  concurrencyPolicy: allow
  testSelector:
    name: sanity-test
    namespace: frontend
  disabled: false
```

You can define **Test Trigger** for Testkube cluster events.
In below example, if **TestWorkflow** `k6-smoke-test` is completed succesfully, then we run **TestWorkflow** `postman-smoke-tests`

```yaml
apiVersion: tests.testkube.io/v1
kind: TestTrigger
metadata:
  name: testtrigger-event
  namespace: testkube
spec:
  resource: event
  resourceSelector:
    name: k6-smoke-test
  event: event-end-test-success
  action: run
  execution: testworkflow
  testSelector:
    name: postman-smoke-tests
    namespace: testkube
```

## Disabling Test Triggers

Disabling test triggers can be helpful to test your configuration during the development. Testkube lets you disable them via the API or modifying the CRD directly specifying `disabled` field value as `true`. By default, test triggers are enabled on creation.

## Architecture

Testkube uses [Informers](https://pkg.go.dev/k8s.io/client-go/informers) to watch Kubernetes resources and register handlers
on certain actions on the watched Kubernetes resources.

Informers are a reliable, scalable and fault-tolerant Kubernetes concept where each informer registers handlers with the
Kubernetes API and gets notified by Kubernetes on each event on the watched resources.

## API

Testkube exposes CRUD operations on test triggers in the REST API. Check out the [Open API](../openapi/overview) docs for more info.

## Injected Environment Variables

The following environment variables are automatically injected into each triggered test pod:

- `WATCHER_EVENT_RESOURCE`: resource type
- `WATCHER_EVENT_NAME`: resource name
- `WATCHER_EVENT_NAMESPACE`: resource namespace
- `WATCHER_EVENT_EVENT_TYPE`: event type
